---
layout: post
title: React服务端渲染
subtitle: React学习笔记系列
date: 2019-03-29
author: Jalever
header-img: img/post_2019_react_bg_shadow.jpg
catalog: true
tags:
  - React
---

- [服务端渲染(Server Side Rendering)](#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93server-side-rendering)
    - [利于 SEO](#%E5%88%A9%E4%BA%8E-seo)
    - [提高首屏渲染的速度](#%E6%8F%90%E9%AB%98%E9%A6%96%E5%B1%8F%E6%B8%B2%E6%9F%93%E7%9A%84%E9%80%9F%E5%BA%A6)
    - [前后端都可以使用`JavaScript`](#%E5%89%8D%E5%90%8E%E7%AB%AF%E9%83%BD%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8javascript)
- [React 15.x 中的 SSR](#react-15x-%E4%B8%AD%E7%9A%84-ssr)
    - [相同点](#%E7%9B%B8%E5%90%8C%E7%82%B9)
    - [`renderToString`和`renderToStaticMarkup`的区别](#rendertostring%E5%92%8Crendertostaticmarkup%E7%9A%84%E5%8C%BA%E5%88%AB)
        - [renderToString](#rendertostring)
        - [renderToStaticMarkup](#rendertostaticmarkup)
    - [动态的`React`组件](#%E5%8A%A8%E6%80%81%E7%9A%84react%E7%BB%84%E4%BB%B6)
- [React 16.x 中的 SSR](#react-16x-%E4%B8%AD%E7%9A%84-ssr)
    - [hydrate](#hydrate)
    - [stream](#stream)

## 服务端渲染(Server Side Rendering)

单页应用将`UI`层和内容都由`JavaScript`来渲染，搜索引擎或网页爬虫需要完成的`HTML`结构，因此单页应用如果只在客户端渲染，不利于`SEO`，此外尽管我们可以通过按需加载的形式来减少首页加载的`JavaScript`，但是通过`JavaScript`来渲染`DOM`的时候还是会有一定的时间延迟

#### 利于 SEO

- `React`服务器渲染的方案使你的页面在一开始就有一个`HTML DOM`结构，方便`Google`等搜索引擎的爬虫能爬到网页的内容

#### 提高首屏渲染的速度

- 服务器直接返回一个填满数据的`HTML`，而不是在请求了`HTML`后还需要异步请求首屏数据。

#### 前后端都可以使用`JavaScript`

## React 15.x 中的 SSR

在`React15.x`中，有两个方法来处理`SSR`：

- renderToString
- renderToStaticMarkup

这两个方法都是在`react-dom/server`中提供的，用来在服务端将`virtual dom`渲染成字符串

#### 相同点

`renderToString`和`renderToStaticMarkup`都接受一个参数，这个参数是`react`的组件，返回一段`HTML`字符串

```javascript
renderToString(react element):string

renderToStaticMarkup(react element):string
```

此外`react-dom`中给浏览器端提供了一个`render`方法，`render`方法将`react`组件，添加到真实的`DOM`节点中<br>
`render`实现的就是浏览器端渲染<br>
Sum up<br>
`服务端渲染`<br>
`renderToString`、`renderToStaticMarkup`——>string
`客户端渲染`<br>
`render`——>`HTML`结构

#### `renderToString`和`renderToStaticMarkup`的区别

###### renderToString

&nbsp;&nbsp;将`React Component`转化为`HTML`字符串，生成的`HTML`的`DOM`会带有额外属性：各个`DOM`会有`data-react-id`属性，第一个`DOM`会有`data-checksum`属性<br>
比如在`renderToString`的关于`HomePage`的返回 HTML 字符串结果为

```javascript
<h1 data-reactroot>Home Page</h1>
```

###### renderToStaticMarkup

同样是将`React Component`转化为`HTML`字符串，但是生成`HTML`的`DOM`不会有额外属性，从而节省`HTML`字符串的大小<br>
在`renderToStaticMarkup`中，关于`HomePage`的返回`HTML`字符串结果为：

```javascript
<h1>Home Page</h1>
```
#### 动态的`React`组件
- 页面只是一个静态的`HTML`页面，没有在客户端渲染`React`组件并初始化`React`实例。只有在初始化`React`实例后，才能更新组件的`state`和`props`，初始化`React`的事件系统，执行虚拟`DOM`的重新渲染机制，让`React`组件真正“动”起来<br>
- 因为`data-react-checksum`属性,服务器端渲染了一次`React`组件，在客户端中就不会再渲染一次`React`组件<br>
- 如果使用`renderToString`渲染组件，会在组件的第一个`DOM`带有`data-react-checksum`属性，这个属性是通过`adler32`算法算出来：如果两个组件有相同的`props`和`DOM`结构时，`adler32`算法算出的`checksum`值会一样，有点类似于哈希算法<br>
- 当客户端渲染`React`组件时，首先计算出组件的`checksum`值，然后检索`HTML DOM`看看是否存在数值相同的`data-react-checksum`属性，如果存在，则组件只会渲染一次，如果不存在，则会抛出一个`warning`异常。也就是说，当服务器端和客户端渲染具有相同的`props`和相同`DOM`结构的组件时，该`React`组件只会渲染一次

## React 16.x 中的 SSR

#### hydrate

如果客户端要在服务端的基础上进行渲染，那么可以使用`hydrate`.

#### stream

此外`React16.x`中，针对`renderToString`和`renderToStaticMarkup`提供了`stream`的方法：

- renderToNodeStream
- renderToStaticNodeStream
  这两个方法同样接受的参数为`react element`，但是返回的不是`HTML`字符串，而是一个可读流
